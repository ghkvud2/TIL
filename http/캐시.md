# 캐시

## 1. 캐시 처리 단계

#### 1-1). 요청 받기

- 캐시는 네트워크 커넥션에서의 활동을 감지하고, 들어오는 데이터를 읽어들인다.

#### 1-2). 파싱

- 캐시는 요청 메시지를 여러 부분으로 파싱하여 헤더 부분을 조작하기 쉬운 자료 구조에 담는다.

#### 1-3). 검색

- 캐시는 URL을 알아내고 그에 해당하는 로컬 사본이 있는지 검사한다.
- 만약, 문서를 로컬에서 가져올 수 없다면, 캐시는 설정에 따라서 원 서버나 부모 프락시에서 가져오거나 실패를 반환한다.
- 캐시된 객체는 서버 응답 본문과 원 서버의 응답 헤더를 포함하고 있으므로, 캐시 적중 동안 올바른 서버 헤더가 반환될 수 있다.

#### 1-4). 신선도 검사

- HTTP는 캐시가 일정 기간 동안 서버 문서의 사본을 보유할 수 있도록 해준다.
- 이 기간 동안, 문서는 **신선**한것으로 간주되고, 캐시는 서버와의 접촉 없이 이 문서를 제공할 수 있다.
- 그러나, 캐시된 사본의 신선도 한계를 넘을정도로 너무 오래갖고 있었다면, 원 서버와의 재검사를 통해 캐시된 문서를 갱신해야한다.

#### 1-5). 응답

- 캐시된 응답을 원 서버에서 온 것처럼 보이게하기 위해 서버 응답 헤더를 토대로 응답 헤더를 생성한다.
- 더불어, 요청이 프락시 캐시를 거쳐갔음을 알려주기 위해 종종 Via 헤더를 포함시킨다.

#### 1-6). 전송

- 응답 헤더가 준비되면, 캐시는 응답을 클라이언트에게 돌려준다.
- 프락시 캐시는 클라이언트와의 커넥션을 유지할 필요가 있다.



## 2. 캐시 신선도 유지하기

- 캐시된 사본 모두가 서버의 문서와 항상 일치하는 것은 아니다.
- HTTP는 어떤 캐시가 사본을 갖고 있는지 서버가 기억하지 않더라도, 캐시된 사본이 서버와 충분히 일치하도록 유지할 수 있게 해주는 메커니즘을 갖고 있는데, 이를 `서버 재검사`라고 부른다.



#### 2-1) 문서 만료

- HTTP는 `Cache-control`과 `Expires`라는 특별한 헤더들을 이용해서 원 서버가 각 문서에서 유효기간을 붙일 수 있게 해준다.
- 이 헤더들은 컨텐츠가 얼마동안 `신선한`상태로 유지될 수 있는지 나타낸다.
- 캐시된 문서가 만료되면, 문서가 변경되었는지 서버를 통해 검사해야하며, 만약 그렇다면 신선한 사본을 얻어와야 한다.



#### 2-2) 서버 재검사

- 캐시된 문서가 만료되었다고해서, 원 서버에 존재하는 문서와 내용이 반드시 다르다는 것은 아니다.
- 다만, 문서의 신선도를 다시 재확인할 필요가 있다는 것이고, 이러한 과정을 `서버 재검사`라고 부른다.
- **재검사 결과 컨텐츠가 변경되었다면, **캐시는 그 문서의 새로운 사본을 가져와 오래된 데이터 대신 저장하고 클라이언트에게도 보내준다.
- **재검사 결과 컨텐츠가 변경되지 않았다면, **캐시는 새 만료일을 포함한 새 헤더들만 가져와서 캐시 안의 헤더들을 갱신한다.



#### 2-3) 조건부 메소드와의 재검사

- HTTP의 조건부 메소드는 재검사를 효율적으로 만들어준다.
- HTTP는 캐시가 서버에게 `조건부 GET`이라는 요청을 보낼 수 있게 해준다.  이 요청은 서버가 갖고 있는 문서가 캐시가 갖고 있는 것과 다른 경우에만 객체 본문을 보내달라고 하는 것이다.

|           헤더            | 설명                                                         |
| :-----------------------: | ------------------------------------------------------------ |
| if-Modified-Since :<date> | 만약 문서가 주어진 날짜 이후로 수정되었다면, 요청 메소드를 처리한다.<br>이것은 캐시된 버전으로부터 컨텐츠가 변경된 경우에만 컨텐츠를 가져오기 위해 Last-Modified 서버 응답 헤더와 함께 사용된다. |
|   if-None-Match: <tags>   | 마지막 변경된 날짜를 맞춰보는 대신, 서버는 문서에 대한 일련번호와 같이 동작하는 특별한 태그를 제공할 수 있다. <br>if-None-Match 헤더는 캐시된 태그가 서버에 있는 문서의 태그와 다를 때만 요청을 처리한다. |

