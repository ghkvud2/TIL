# 웹 서버

## 1. 웹 서버가 하는 일



### 1. 커넥션을 맺는다.

- 클라이언트의 접속을 받아들이거나, 원치 않는 클라이언트라면 닫는다.
- 클라이언트가 이미 서버에 대해 열려있는 지속 커넥션을 갖고 있다면, 클라이언트는 요청을 보내기 위해 그 커넥션을 사용할 수 있다.



#### 1-1) 새 커넥션 다루기

- 클라이언트가 웹 서버에 TCP 커넥션을 요청하면, 웹 서버는 그 커넥션을 맺고 TCP 커넥션에서 IP 주소를 추출하여 커넥션을 요청한 클라이언트를 확인한다.
- 일단 새 커넥션이 맺어지면, 서버는 새 커넥션을 커넥션 목록에 추가하고 커넥션으로부터 요청을 받을 준비를 한다.



#### 1-2)클라이언트 호스트명 식별

- 대부분의 웹 서버는 `역방향 DNS`를 사용해서 클라이언트의 IP주소를 클라이언트의 호스트명으로 변환하도록 설정되어 있다.
- 다만, 호스트명 `룩업`은 꽤 많은 시간이 걸릴 수 있어서 웹 트랜잭션이 느려질 수 있다.



#### 1-3) ident를 통해 클라이언트 사용자 알아내기

- `ident`프로토콜은 서버에게 어떤 사용자 이름이 HTTP 커넥션을 초기화했는지 찾아낼 수 있게 해준다.
- 클라이언트가 `ident` 프로토콜을 지원한다면 클라이언트는 `ident` 결과를 위해 TCP 포트 `113`번을 `listen`한다.

![](https://flylib.com/books/1/2/1/html/2/049_files/image001.gif)

1. 클라이언트 (Mary)는 서버에 HTTP 커넥션을 생성한다.
2. 그 후, 서버는 자신의 커넥션을 클라이언트의 identd 서버 포트(113)을 행햐 열고, 요청을 보낸다.
3. identd 서버는 요청에대해 응답을 전송한다.



### 2. 요청 메시지 수신과 처리

- 커넥션에 데이터가 도착하면, 웹 서버는 그 데이터를 읽어들이고 파싱하여 요청 메시지를 구성한다.
- 웹 서버는 요청 메시지를 파싱해서 이해하는 것이 가능한 수준의 분량을 확보할 때까지 데이터의 일부분을 메모리에 임시로 저장해둘 필요가 있다.

- 웹 서버는 요청 메시지를 쉽게 다룰 수 있도록 내부의 자료 구조에 저장한다.

![](https://flylib.com/books/1/2/1/html/2/050_files/image002.gif)



### 3. 리소스의 매핑과 접근

- 웹 서버는 HTML 페이지나 이미지 같이 미리 만들어진 정적 컨텐츠를 제공한다.
- 웹 서버가 클라이언트에 컨텐츠를 전달하려면, 그전에 요청 메시지의 URI에 대응하는 컨텐츠를 웹 서버에서 찾아서 식별할 수 있어야 한다.

#### 3-1) Docroot

- 리소스 매핑의 가장 단순한 형태는 요청 URI를 웹 서버의 파일 시스템 안에 있는 파일 이름으로 사용하는 것이다.
- 일반적으로, 웹 서버 파일 시스템의 특별한 폴더를 웹 컨텐츠를 위해 예약해 두는데, 이를 `docroot`라고 한다.



#### 3-2) 동적 컨텐츠 리소스 매핑

- 웹 서버는 어떤 리소스가 동적 리소스라면, 어플리케이션 서버는 그에 대한 동적 컨텐츠 생성 프로그램이 어디에 있는지, 그리고 어떻게 그 프로그램을 실행하는지 알려줄 수 있어야 한다.

![](https://flylib.com/books/1/2/1/html/2/052_files/image004.gif)



### 4. 응답 만들기

- 서버는 요청 메소드로 서술되는 동작을 수행한 뒤 응답 메시지를 반환한다.
- 응답 메시지는 상태 코드, 응답 헤더, 응답 본문을 포함한다.



#### 4-1) 응답 엔티티

- 만약 트랜잭션이 응답 본문을 생성한다면, 그 내용을 응답 메시지와 함께 돌려보낸다.
- 만약, 본문이 있다면 응답 메시지는 아래와 같은 내용을 포함한다.

1. 응답 본문의 MIME 타입을 서술하는 Content-Type 헤더
2. 응답 본문의 길이를 서술하는 Content-Length 헤더
3. 실제 응답 본문의 내용



#### 4-2) MIME 타입 결정하기

- 웹 서버는 응답 본문의 MIME 타입을 결정해야 하는 책임이 있다.



1. mime.types

   - 웹 서버는 MIME 타입을 나타내기 위해 파일 이름의 확장자를 사용할 수 있다.
   - 웹 서버는 각 리소스의 MIME 타입을 계산하기 위해 확장자별 MIME 타입이 담겨 있는 파일을 탐색한다.

   ![](https://flylib.com/books/1/2/1/html/2/053_files/image001.gif)